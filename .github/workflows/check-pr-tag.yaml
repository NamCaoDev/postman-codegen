name: Check PR Tag

on:
  pull_request:
    types: [opened, synchronize, reopened, labeled, unlabeled, edited]

jobs:
  check-version:
    runs-on: ubuntu-latest
    steps:
      - name: Extract tag from PR labels
        id: extract
        run: |
          echo "🔍 Extracting version label from PR labels..."

          LABELS_JSON='${{ toJson(github.event.pull_request.labels) }}'
          echo "📌 All PR labels:"
          echo "$LABELS_JSON" | jq

          VERSION=$(echo "$LABELS_JSON" | jq -r '.[] | select(.name | test("^v[0-9]+\\.[0-9]+\\.[0-9]+$")) | .name' | head -n 1)

          if [ -z "$VERSION" ]; then
            echo "❌ No version label (vX.Y.Z) found among PR labels."
            exit 1
          fi

          echo "✅ Found version label: $VERSION"
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"
          
      - name: Get current version from NPM
        id: npm
        run: |
          # Get the current version from NPM
          CURRENT=$(npm view @namcaodev/postman-codegen version)
          echo "Current NPM version: $CURRENT"
          echo "current=$CURRENT" >> "$GITHUB_OUTPUT"

      - name: Compare versions
        run: |
          # Compare the new version with the current NPM version using semver
          npm install -g semver
          echo "Comparing ${{ steps.extract.outputs.version }} > ${{ steps.npm.outputs.current }}"
          if ! semver -r ">${{ steps.npm.outputs.current }}" "${{ steps.extract.outputs.version }}"; then
            echo "❌ PR version must be greater than current NPM version."
            exit 1
          else
            echo "✅ Valid version"
          fi
