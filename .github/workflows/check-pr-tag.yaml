name: Check PR Tag

on:
  pull_request:
    types: [opened, synchronize, reopened, labeled, unlabeled, edited]

jobs:
  check-version:
    runs-on: ubuntu-latest

    steps:
      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Extract tag from PR labels
        id: extract
        run: |
          echo "üîç Extracting version label from PR labels..."

          LABELS=$(echo '${{ toJson(github.event.pull_request.labels) }}' | jq -r '.[] | select(.name | test("^v[0-9]+\\.[0-9]+\\.[0-9]+$")) | .name')

          echo "ü™µ Labels extracted: $LABELS"

          if [ -z "$LABELS" ]; then
            echo "‚ùå No version label (vX.Y.Z) found."
            exit 1
          fi

          LABEL_COUNT=$(echo "$LABELS" | grep -c '^')
          if [ "$LABEL_COUNT" -ne 1 ]; then
            echo "‚ùå There should be exactly one version label, found $LABEL_COUNT."
            exit 1
          fi

          VERSION=$(echo "$LABELS" | head -n 1)
          echo "‚úÖ Found valid version: $VERSION"
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"

      - name: Get current version from NPM
        id: npm
        run: |
          CURRENT=$(npm view @namcaodev/postman-codegen version)
          echo "üì¶ Current NPM version: $CURRENT"
          echo "current=$CURRENT" >> "$GITHUB_OUTPUT"

      - name: Compare versions
        run: |
          npm install -g semver
          NEW_VERSION="${{ steps.extract.outputs.version }}"
          CURRENT_VERSION="${{ steps.npm.outputs.current }}"
          echo "üî¢ Comparing: $NEW_VERSION > $CURRENT_VERSION"
          if ! semver -r ">$CURRENT_VERSION" "$NEW_VERSION"; then
            echo "‚ùå PR version must be greater than current NPM version."
            exit 1
          else
            echo "‚úÖ Valid version"
          fi
